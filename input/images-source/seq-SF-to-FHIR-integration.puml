@startuml seq-SF-to-FHIR-integration


autonumber "<b> 00"

skinparam ArrowFontSize 16
skinparam BoxPadding 10
skinparam dpi 400
skinparam MaxMessageSize 350
skinparam NoteFontSize 13
skinparam ParticipantPadding 5
skinparam responseMessageBelowArrow true
skinparam roundcorner 15
skinparam sequenceArrowThickness 2
skinparam SequenceMessageAlignment left
skinparam ArrowFontSize 12
skinparam sequenceStyle uml2
skinparam sequencegroupfontsize 14
' semi-transparent sequence groups!
' see https://sarafian.github.io/tips/2021/03/11/plantuml-tips-tricks-1.html#:~:text=responseMessageBelowArrow-,Semi,-transparent%20group%20backgrounds
skinparam SequenceGroupBodyBackgroundColor #EEEEFF50

scale max 500 width


'' ** page 1
title "Rheumatic Fever: Salesforce Health Cloud patient registration integration to Te Whatu Ora FHIR"

actor "rheumatic fever collaborator" as USER
participant "FHIR-integrated APP/UX" as APIC #Orange
participant "Salesforce\nHealth Cloud" as OLLIE #YellowGreen
database "Salesforce Mulesoft Connector\nplatform event" as SHIFTER #IndianRed
database "Integration Health \nMonitoring (Datadog)" as WATCHDOG #LightCyan
participant "Mulesoft" as TILLY #SkyBlue

  entity "NIA OAUTH service" as WICKET
  entity "**HNZ FHIR API**\n(AWS FHIRWorks)" as FHIR #LightSalmon


entity "NHI FHIR API" as NHI

autonumber stop

?-> TILLY: init
TILLY -> WICKET++: OAUTH2.0 Client Credentials Flow(\n\t1. api-key\n\t2. service provider's client credentials) 
return OAUTH token

activate USER
USER -> OLLIE: start registering RF patient 
USER -> OLLIE: enter patient name, NHI 
OLLIE -> NHI: NHI search
OLLIE -> USER: confirm correct NHI to use
USER -> OLLIE: select correct NHI
USER -> OLLIE: enter other registration data
USER -> OLLIE++ #YellowGreen: Patient registration valid\n data entry completed

USER -> USER:  User is now free to \nprogress other RF tasks
deactivate USER

OLLIE -/ SHIFTER #IndianRed: <color:red>PATIENT-CHANGE (SF obj. Ids)
note right of SHIFTER #Yellow: Platform events stored \nfor up to 3 days for replay if needed
TILLY -> SHIFTER #SkyBlue: <color:red>get next event (SF object IDs)
activate TILLY #SkyBlue

TILLY -/ WATCHDOG: Log start of processing \nplatform event

note right of TILLY #Yellow
  1. Salesforce records 'platform event' in proprietary storage shared with Mulesoft.  
  2. Mulesoft writes a log record marking start of integration sequence processing.
  3. The integration sequence is designed as an idempotent set of FHIR operations 
    which can be restarted/repeated without loss of FHIR data integrity.
  4. If the sequence aborts for some technical reason, the platform event status will
    indicate to Salesforce Mule couldn't finish the job ie. the sequence didn't complete. 
endnote

note left of SHIFTER #Yellow
  Salesforce connector keeps track of
  last platform event processed. 
endnote

TILLY -> OLLIE: Retrieve Patient data \n<size:10>(Salesforce REST API composite request)
deactivate OLLIE
TILLY -> FHIR++: ""GET /Patient?""\n""identifier=https://standards.digital.health.nz/ns/nhi-id|{{NHI}}&""\n""_profile={{RF Patient profile}}""
FHIR -> TILLY--: ""200 OK"" bundle

  TILLY -> TILLY: Form FHIR Bundle payload from Patient, CarePlan \nand Consent data from Salesforce HealthCloud
  TILLY -> FHIR++: ""POST /Bundle""
  note left of TILLY: Mulesoft retries \nFHIR API call if needed
  group transaction POST bundle
    FHIR -> PATIENT: POST new instance
    FHIR -> CAREPLAN: POST new instance
  end

  FHIR -> TILLY--: ""201 CREATED"" - instance representations 
  TILLY -/ WATCHDOG: Log FHIR operation outcomes

deactivate TILLY 


@enduml